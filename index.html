<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Population Circles Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link href="https://trst.uk/css/app.css" rel="stylesheet">
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.4/proj4.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://kit.fontawesome.com/19a0336ebe.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Raleway', sans-serif;
            background-color: #ffffff;
        }
        #header {
            width: 100%;
            background-color: #FFFFFF;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        #header img {
            height: 100px;
        }
        #pointsTable {
            width: 80%; /* Or whatever width you prefer */
            margin-left: auto;
            margin-right: auto;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        th {
            background-color: #5D3FD3;
            color: white;
        } 
        #map { height: 60vh; }
    </style>
</head>
<body>
    <div id="header">
        <img src="https://www.trustimpact.com/wp-content/uploads/2020/09/trust-impact-logo.png" alt="Trust Impact Logo">
    </div>
    <h2>Hertiage Index</h2>
    <br>
    <p>Please note this tool uses the Open Data from Historic England's April 2024 submission (https://historicengland.org.uk/listing/the-list/data-downloads/) </p>


<div id="map"></div>

<div id="tableContainer">
    <h3>Data Points within Circle</h3>
    <table id="pointsTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>NHLE Link</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table rows will be added dynamically with JavaScript -->
        </tbody>
    </table>
</div>


<script>
    
    // single circle
    var currentCircle = null; // This variable will hold the reference to the current circle
    var allPoints = []; // Define this outside to collect all latLngs
    var loadedData = []; // This will store the data loaded from the CSV



    // Initialize the map
    var map = L.map('map').setView([53.383331, -1.466667], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var allPoints = []; // Define this outside to collect all latLngs

    // Function to add points to the map using latitude and longitude
    function addPoints(data) {
    data.forEach(function(item) {
        var latitude = parseFloat(item.Latitude);
        var longitude = parseFloat(item.Longitude);

        // Check if latitude and longitude are valid numbers
        if (!isNaN(latitude) && !isNaN(longitude)) {
            var name = item.Name;
            var latLng = [latitude, longitude];

            // Add a circle marker for each valid data point
            var circleMarker = L.circleMarker(latLng, {
                color: 'Green',
                fillColor: '#228B22',
                fillOpacity: 0.25,
                radius: 5
            }).addTo(map);
        
            circleMarker.bindPopup(name);
            allPoints.push(latLng);
        } else {
            // Optionally, log invalid items for debugging
            console.error('Invalid LatLng for item:', item);
        }
    });
}

    // Handle map click events
    map.on('click', function(e) {
    // If there's already a circle, remove it
    if (currentCircle) {
        map.removeLayer(currentCircle);
    }

    var radius = 5 * 1609.34; // Radius of 5 miles in meters

    // Create a new circle and add it to the map
    currentCircle = L.circle(e.latlng, radius, {
        color: 'blue',
        fillColor: '#f03',
        fillOpacity: 0.1
    }).addTo(map);

    var pointsWithinCircle = []; // Initialize an array to store the points within the circle

    allPoints.forEach(function(point, index) {
        var distance = map.distance(e.latlng, point);
        if (distance <= radius) {
            pointsWithinCircle.push(loadedData[index]);
        }
    });

    updateTable(pointsWithinCircle); // Call the function to update the table with these points
});


function updateTable(data) {
    var tableBody = document.getElementById('pointsTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ""; // Clear existing table rows

    data.forEach(function(item) {
        var row = tableBody.insertRow();
        var nameCell = row.insertCell(0);
        var typeCell = row.insertCell(1); // New cell for Type
        var linkCell = row.insertCell(2); // Adjusted to be the third cell

        nameCell.textContent = item.Name;
        typeCell.textContent = item.Type; // Set the text content for Type cell

        // Correctly access the 'NHLE link' property using bracket notation
        var nhleLink = item['NHLE link']; // Note the space in 'NHLE link'

        // Check if the NHLE link is not undefined or empty
        if(nhleLink) {
            // Use bracket notation to include the property name exactly as it appears in the CSV
            linkCell.innerHTML = `<a href="${nhleLink}" target="_blank">Link</a>`;
        } else {
            linkCell.textContent = "No Link Provided"; // Or handle the absence of a link however you prefer
        }
    });
}


// Function to parse and add points from a CSV file
function loadAndAddPointsFromCSV(csvUrl) {
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            console.log("CSV Data Loaded from " + csvUrl, results.data);
            loadedData = loadedData.concat(results.data); // Append the new data to the existing data
            addPoints(results.data); // Add the new points to the map
        }
    });
}

// Initial CSV file (already in your script)
loadAndAddPointsFromCSV('https://raw.githubusercontent.com/TrustImpact/heritagemap/main/parks.csv');

// Additional CSV files
loadAndAddPointsFromCSV('https://raw.githubusercontent.com/TrustImpact/heritagemap/main/WHS.csv');
loadAndAddPointsFromCSV('https://raw.githubusercontent.com/TrustImpact/heritagemap/main/battlefields.csv');
loadAndAddPointsFromCSV('https://raw.githubusercontent.com/TrustImpact/heritagemap/main/listedbuildings.csv');
loadAndAddPointsFromCSV('https://raw.githubusercontent.com/TrustImpact/heritagemap/main/monuments.csv');

</script>
</body>
</html>
