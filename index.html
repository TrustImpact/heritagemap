<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Population Circles Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link href="https://trst.uk/css/app.css" rel="stylesheet">
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.4/proj4.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://kit.fontawesome.com/19a0336ebe.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Raleway', sans-serif;
            background-color: #ffffff;
        }
        #header {
            width: 100%;
            background-color: #FFFFFF;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        #header img {
            height: 100px;
        }
        #pointsTable {
            width: 80%; /* Or whatever width you prefer */
            margin-left: auto;
            margin-right: auto;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        th {
            background-color: #5D3FD3;
            color: white;
        } 
        #map {
            height: 60vh;
            width: calc(100% - 240px); /* Example: Adjust based on your layout */
            float: left;
            margin-bottom: 20px; /* Adjust this value to create more or less space */
        }
        #inputContainer {
            display: flex;
            justify-content: flex-end;
            padding: 20px; /* Adjust as necessary */
            gap: 20px; /* Creates space between the input groups */
        }

        #radiusInputContainer, #postcodeSearchContainer {
            display: flex;
            flex-direction: column; /* Stack label and input vertically */
            align-items: flex-start; /* Aligns items to the start, making it neater */
        }
        #toolInstructionsAndInputs {
            display: flex;
            justify-content: space-between; /* This separates the text and the inputs */
            align-items: center; /* This vertically centers them if they're of different heights */
            flex-wrap: wrap; /* This allows them to wrap onto a new line on smaller screens */
        }

        #instructionsText {
            flex-basis: 50%; /* Adjust based on your needs */
            /* You might want to add some padding or margin for spacing */
        }

        #inputsContainer {
            flex-basis: 40%; /* Adjust based on your needs */
            display: flex;
            justify-content: space-between; /* Adjust if you have multiple inputs */
            /* You might want to add some padding or margin for spacing */
        }
    </style>
</head>
<body>
    <div id="header">
        <img src="https://www.trustimpact.com/wp-content/uploads/2020/09/trust-impact-logo.png" alt="Trust Impact Logo">
    </div>
    <h2>Heritage Index</h2>
    <br>

    <div id="toolInstructionsAndInputs">
        <p id="instructionsText">To use this tool, you can either enter a postcode or click directly on the map to produce a profile of the sites of significant heritage close to that location. This tool uses the Open Data from Historic England's April 2024 submission (https://historicengland.org.uk/listing/the-list/data-downloads/) </p>

        <div id="inputContainer" style="display: flex; justify-content: flex-end; padding: 20px;">
            <div id="radiusInputContainer">
                <label for="radiusInput">Radius in Miles:</label>
                <input type="number" id="radiusInput" value="5" min="1" step="any">
            </div>

            <br>

            <div id="postcodeSearchContainer">
                <label for="postcodeInput">Postcode:</label>
                <input type="text" id="postcodeInput" placeholder="Enter postcode">
                <button id="postcodeSearchButton">Go</button>
            </div>
        </div>
    </div>

    <div id="dataOptions">
        <label><input type="checkbox" id="loadmonuments" /> Load Monuments</label>
        <label><input type="checkbox" id="loadParks" /> Load Parks</label>
        <label><input type="checkbox" id="loadWHS" /> Load World Heritage Sites</label>
        <label><input type="checkbox" id="loadBattlefields" /> Load Battlefields</label>
        <label><input type="checkbox" id="loadListedBuildings" /> Load Listed Buildings</label>
    </div>

    <div id="map"></div>

    <br>

    <div id="summaryContainer">
        <h3>Summary of Data Points</h3>
        <ul id="summaryList">
            <!-- Summary items will be dynamically inserted here -->
        </ul>
    </div>

    <br>

    <div id="tableContainer">
        <table id="pointsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>NHLE Link</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be added dynamically with JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        var map; // Define map globally
        var currentCircle = null; // This variable will hold the reference to the current circle
        var allPoints = []; // Define this outside to collect all latLngs
        var loadedData = []; // This will store the data loaded from the CSV

        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('map').setView([53.383331, -1.466667], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            addEventListeners();
            loadInitialData(); // Ensures map is defined before calling
        });

        function addEventListeners() {
            document.getElementById('loadParks').addEventListener('change', loadDataset);
            document.getElementById('loadWHS').addEventListener('change', loadDataset);
            document.getElementById('loadBattlefields').addEventListener('change', loadDataset);
            document.getElementById('loadListedBuildings').addEventListener('change', loadDataset);
            document.getElementById('loadmonuments').addEventListener('change', loadDataset);

            document.getElementById('postcodeSearchButton').addEventListener('click', postcodeSearch);
            map.on('click', function(e) {
                drawCircleAndUpdateData(e.latlng);
            });
        }

        function loadDataset(event) {
            if (event.target.checked) {
                var datasetMap = {
                    'loadParks': 'parks.csv',
                    'loadWHS': 'WHS.csv',
                    'loadBattlefields': 'battlefields.csv',
                    'loadListedBuildings': 'listedbuildings.csv',
                    'loadmonuments': 'monuments.csv'
                };
                loadAndAddPointsFromCSV(`https://raw.githubusercontent.com/TrustImpact/heritagemap/main/${datasetMap[event.target.id]}`);
            }
        }

        function postcodeSearch() {
    var postcode = document.getElementById('postcodeInput').value;
    var apiKey = '0fa315c939ca4836b78520deac87bdae';
    var apiURL = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(postcode)}&key=${apiKey}`;

    fetch(apiURL)
        .then(response => response.json())
        .then(data => {
            if (data && data.results && data.results.length > 0) {
                var lat = data.results[0].geometry.lat;
                var lng = data.results[0].geometry.lng;
                drawCircleAndUpdateData([lat, lng]);
            } else {
                alert("Could not find the location for that postcode.");
            }
        })
        .catch(error => {
            console.error('Error during geocoding:', error);
            alert('Failed to geocode postcode.');
        });
}

function loadAndAddPointsFromCSV(csvUrl) {
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            loadedData = loadedData.concat(results.data); // Append new data
            addPoints(results.data); // Add the new points to the map
            updateTable(loadedData); // Optionally update table with new data
            updateSummary(loadedData); // Optionally update summary with new data
        }
    });
}

function addPoints(data) {
    data.forEach(function(item) {
        var latitude = parseFloat(item.Latitude);
        var longitude = parseFloat(item.Longitude);

        if (!isNaN(latitude) && !isNaN(longitude)) {
            var name = item.Name;
            var latLng = [latitude, longitude];

            var circleMarker = L.circleMarker(latLng, {
                color: 'Green',
                fillColor: '#228B22',
                fillOpacity: 0.25,
                radius: 5
            }).addTo(map);

            circleMarker.bindPopup(name);
            allPoints.push({latLng: latLng, data: item}); // Store data along with latLng
        } else {
            console.error('Invalid LatLng for item:', item);
        }
    });
}

function drawCircleAndUpdateData(latlng) {
    var inputRadius = document.getElementById('radiusInput').value;
    var radius = inputRadius * 1609.34; // Convert miles to meters

    if (currentCircle) {
        map.removeLayer(currentCircle);
    }

    currentCircle = L.circle(latlng, { radius: radius, color: 'blue', fillColor: '#f03', fillOpacity: 0.1 }).addTo(map);
    map.setView(latlng, 10); // Adjust zoom level as necessary

    var pointsWithinCircle = allPoints.filter(function(point) {
        return map.distance(latlng, point.latLng) <= radius;
    }).map(function(point) {
        return point.data;
    });

    updateTable(pointsWithinCircle);
    updateSummary(pointsWithinCircle);
}

function updateTable(data) {
    var tableBody = document.getElementById('pointsTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ""; // Clear existing table rows

    data.forEach(function(item) {
        var row = tableBody.insertRow();
        var nameCell = row.insertCell(0);
        var typeCell = row.insertCell(1);
        var linkCell = row.insertCell(2);

        nameCell.textContent = item.Name;
        typeCell.textContent = item.Type;
        // Correct property name to match the CSV header exactly
        var nhleLink = item['NHLE link']; 
        linkCell.innerHTML = nhleLink ? `<a href="${nhleLink}" target="_blank">Link</a>` : "No Link Provided";
    });
}
function updateSummary(data) {
    var summary = data.reduce(function(acc, item) {
        acc[item.Type] = (acc[item.Type] || 0) + 1;
        return acc;
    }, {});

    var summaryList = document.getElementById("summaryList");
    summaryList.innerHTML = ""; // Clear previous summary

    Object.keys(summary).forEach(function(type) {
        var li = document.createElement("li");
        li.textContent = `${type}: ${summary[type]}`;
        summaryList.appendChild(li);
    });
}

</script>
</body>
</html>
